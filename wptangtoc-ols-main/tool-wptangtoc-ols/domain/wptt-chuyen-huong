#!/bin/bash
# @since: 2022
# @website: https://wptangtoc.com
# @author: Gia Tuấn
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý Domain => Chuyển hướng domain                                  |"
echo "========================================================================="
echo ""
echo ""

. /etc/wptt/.wptt.conf
. /etc/wptt/echo-color
read -p "Nhập domain bạn muốn chuyển hướng đi 
    (vidu: wptangtoc.com, giatuan.com ...) [0=Thoát]: " NAME


if [[ "$NAME" = "0" ]]; then
  clear
  . /etc/wptt/wptt-domain-main 1
  exit
fi

read -p "Nhập domain bạn muốn chuyển hướng tới
    (vidu: wptangtoc.com, wptangtoc.vn ...) [0=Thoat]: " NAME2

USER=${NAME//[-._]/}

if [ "$NAME" = '' ]; then
  clear
  echo "Ban chua nhap ten mien domain."
  sleep 3
  . /etc/wptt/wptt-domain-main 1
  exit
fi

if [ "$NAME" = "${NAME/./}" ]; then
  clear
  echo "Domain ten mien nhap khong dung dinh dang."
  exit
fi


path="/etc/wptt/vhost/.$NAME.conf"
pathcheck_chuyen_huong="/etc/wptt/chuyen-huong/.$NAME.conf"

if [[ -f "$pathcheck_chuyen_huong" ]];then
echoDo "domain $NAME đã được chuyển hướng trước đó rồi"
echoDo "Nếu bạn muốn thay đổi chuyển hướng đến domain khác hãy xóa chuyển hướng rồi quay lại thiết lập"
exit
fi

_runing "Thiết lập $NAME chuyển hướng sang $NAME2"
tuan=$(echo "$NAME" | cut -f2 -d '.')
tuan2=$(echo "$NAME2" | cut -f2 -d '.')

if ! [[ ! -f "$path" ]]; then
 echo 'RewriteEngine On
RewriteCond %{HTTP_HOST} ^'$NAME'$ [NC, OR]
RewriteCond %{HTTP_HOST} ^www.'$NAME' [NC]
RewriteRule (.*)$ https://'$NAME2'/$1 [L, R=301,NC]
' >/usr/local/lsws/$NAME/html/.htaccess

echo "" > /etc/wptt/chuyen-huong/.$NAME.conf

if [[ -f /etc/wptt/vhost/.$NAME.conf ]];then
rf -f /etc/wptt/vhost/.$NAME.conf
fi
_rundone "Thiết lập $NAME chuyển hướng sang $NAME2"
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
  exit
fi

# # pathuser="/home/$USER"
# if [[ $(cat /etc/passwd | cut -f1 -d ':' | grep -w $USER) ]]; then
#   clear
#   echo "User đã tồn tại trên hệ thống."
#   . /etc/wptt/wptt-domain-main 1
#   exit
# fi

if [ "$USER" = '' ]; then
  USER=${NAME//[-._]/}
fi


#ky tu toi da là 32 ký tự user trong linux
check_ky_tu=$(echo $USER | wc -c)
if (( $check_ky_tu > 32 ));then
	USER=$(echo $USER | cut -c 1-30)
fi

# useradd $USER -p -m -d /home/$USER >/dev/null 2>&1
useradd -p -m -d /usr/local/lsws/$NAME $USER >/dev/null 2>&1
if [[ $(cat /etc/passwd | cut -f1 -d ':' | grep -w $USER) = '' ]];then
	random=$(
	date +%s | sha256sum | base64 | head -c 2
	echo
)

USER=${NAME//[-._]/$random}
USER=$(echo $USER | tr '[:upper:]' '[:lower:]')

check_ky_tu2=$(echo $USER | wc -c)
if (( $check_ky_tu2 > 32 ));then
	USER=$(echo $USER | cut -c 1-30)
fi
useradd -p -m -d /usr/local/lsws/$NAME $USER >/dev/null 2>&1
# useradd "$USER" -p -m -d /home/"$USER" >/dev/null 2>&1
fi

#xac dinh user đã được tạo lập chưa
if [[ $(cat /etc/passwd | cut -f1 -d ':' | grep -w $USER) = '' ]];then
	_runloi "Thêm domain $NAME vào hệ thống"
	echoDo "Đã có lỗi vấn đề về hệ điều hành không thể tạo user mới"
	. /etc/wptt/wptt-domain-main 1
	exit
fi


usermod $USER -s /sbin/nologin

. /etc/wptt/.wptt.conf

work_cpucore='1024'
cpucore=$(grep -c ^processor /proc/cpuinfo)
max_client=$(expr $work_cpucore \* $cpucore \* 2)
max_client_max=$(expr $work_cpucore \* $cpucore \* 3)
max_client_php=$(expr $work_cpucore \* $cpucore \/ 8)
tong_ram_byte=$(awk '/MemTotal/ {print $2}' /proc/meminfo)
rong_ram_mb=$(echo "scale=0;${tong_ram_byte}/1024" | bc)
if [[ "$rong_ram_mb" = "" ]]; then
  rong_ram_mb="2048"
fi

_runing "Thêm domain $NAME vào hệ thống"
echo "virtualhost $NAME {
  vhRoot                  /usr/local/lsws/$NAME/
  configFile              /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf
  allowSymbolLink         1
  enableScript            1
  restrained              1
  maxKeepAliveReq         $max_client
  setUIDMode              2
  user                    $USER
  group                   $USER
}" >>/usr/local/lsws/conf/httpd_config.conf
sed -i "/listener http/a map 		$NAME $NAME" /usr/local/lsws/conf/httpd_config.conf
mkdir /usr/local/lsws/conf/vhosts/$NAME/
touch /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf

NAMEPHP=${NAME//[-._]/}

echo "docRoot                   /usr/local/lsws/$NAME/html
vhDomain                  $NAME
enableGzip                1
cgroups                   0
index  {
  useServer               0
  indexFiles              index.html index.php
  autoIndex               0
}
scripthandler  {
  add                     lsapi:$NAMEPHP php
}
accessControl  {
  allow                   *
}
lsrecaptcha  {
  enabled                 1
  type                    0
}
extprocessor $NAMEPHP {
  type                    lsapi
  address                uds://tmp/lshttpd/$NAMEPHP.sock
  maxConns                20
  env                     PHP_LSAPI_CHILDREN=20
  env                     LSAPI_AVOID_FORK=200M
  initTimeout             60
  retryTimeout            0
  pcKeepAliveTimeout      5
  respBuffer              0
  autoStart               1
  path                    /usr/local/lsws/lsphp74/bin/lsphp
  backlog                 100
  instances               1
  extUser                 $USER
  extGroup                $USER
  runOnStartUp            2
  priority                0
  memSoftLimit            ${rong_ram_mb}M
  memHardLimit            ${rong_ram_mb}M
  procSoftLimit           $max_client
  procHardLimit           $max_client
}
context / {
  location                /usr/local/lsws/$NAME/html
  allowBrowse             1
  extraHeaders            <<<END_extraHeaders
X-XSS-Protection 1;mode=block
X-Frame-Options SAMEORIGIN
Referrer-Policy strict-origin-when-cross-origin
X-Content-Type-Options nosniff
X-Powered-By WPTangTocOLS
permissions-policy accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()
  END_extraHeaders
  rewrite  {
  }
  addDefaultCharset       off
  phpIniOverride  {
  }
}
rewrite  {
  enable                  1
  autoLoadHtaccess        1
/usr/local/lsws/$NAME/html/.htaccess
}
vhssl  {
  keyFile                 /etc/letsencrypt/live/$NAME/privkey.pem
  certFile                /etc/letsencrypt/live/$NAME/cert.pem
  certChain               0
  CACertFile              /etc/letsencrypt/live/$NAME/chain.pem
  sslProtocol             24
  renegProtection         1
  sslSessionCache         1
  sslSessionTickets       1
  enableSpdy              15
  enableQuic              1
  enableStapling          1
  ocspRespMaxAge          86400
  ocspResponder           http://cert.int-x3.letsencrypt.org/
  ocspCACerts             /etc/letsencrypt/live/$NAME/chain.pem
}
module cache {
checkPrivateCache   1
checkPublicCache    1
maxCacheObjSize     10000000
maxStaleAge         200
qsCache             1
reqCookieCache      1
respCookieCache     1
ignoreReqCacheCtrl  1
ignoreRespCacheCtrl 0
storagePath /usr/local/lsws/$NAME/luucache
enableCache         0
expireInSeconds     3600
enablePrivateCache  0
privateExpireInSeconds 3600
  ls_enabled              1
}

context /.well-known/acme-challenge {
  location                /usr/local/lsws/Example/html/.well-known/acme-challenge
  allowBrowse             1

  rewrite  {
     enable                  0
  }
  addDefaultCharset       off

  phpIniOverride  {

  }
}

" >/usr/local/lsws/conf/vhosts/$NAME/$NAME.conf

php_ver_chon=${php_version_check//[-._]/}
sed -E -i "s/lsphp[0-9]+/lsphp$php_ver_chon/g" /usr/local/lsws/conf/vhosts/$NAME/$NAME.conf

chown -R lsadm:nobody /usr/local/lsws/conf/vhosts/$NAME
chmod -R 750 /usr/local/lsws/conf/vhosts/$NAME
mkdir -p /usr/local/lsws/$NAME
mkdir -p /usr/local/lsws/$NAME/html
mkdir -p /usr/local/lsws/$NAME/luucache
chmod 755 /usr/local/lsws/$NAME
chmod 755 /usr/local/lsws/$NAME/html

useradd -p -m -d /usr/local/lsws/$NAME $USER >/dev/null 2>&1
chown -R $USER:$USER /usr/local/lsws/$NAME/html
_rundone "Thêm domain $NAME vào hệ thống"

_runing "Thiết lập $NAME chuyển hướng sang $NAME2"
echo 'RewriteEngine On
RewriteCond %{HTTP_HOST} ^'$NAME'$ [NC, OR]
RewriteCond %{HTTP_HOST} ^www.'$NAME' [NC]
RewriteRule (.*)$ https://'$NAME2'/$1 [L, R=301,NC]
' >/usr/local/lsws/$NAME/html/.htaccess

mkdir -p /etc/wptt/chuyen-huong
touch /etc/wptt/chuyen-huong/.$NAME.conf
/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
_rundone "Thiết lập $NAME chuyển hướng sang $NAME2"

checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdns" = "" ]]; then
  checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi

ip=$(curl -s myip.directadmin.com)
if [[ "$ip" = "" ]]; then
  ip=$(curl -s ifconfig.me)
fi

if [[ "$checkdns" != "$ip" ]]; then
  if [[ "$checkdns" = "" ]]; then
    echo "Tên miền $NAME chưa được trỏ IP, giá trị IP của $NAME là không có giá trị nào, bạn vui lòng trỏ IP về $ip"
  else
    echo "Hãy trỏ DNS domain $NAME: $checkdns thành $ip để tận hưởng thành quả"
  fi
fi 



check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-domain-main 1
fi

