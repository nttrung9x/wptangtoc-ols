#!/bin/bash
# @author: Gia Tuấn
# @website: https://wptangtoc.com
# @since: 2023
. /etc/wptt/echo-color
NAME=$1

if [[ $NAME = "98" ]];then
NAME=""
fi

if [[ $NAME = "" ]];then
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý SSL => Renew chuyển hướng HTTP TO HTTPS                        |"
echo "========================================================================="
. /etc/wptt/tenmien-them-lua-chon-tat-ca-website
echo ""
echo ""
echo "Lựa chọn website renew chuyển hướng (HTTPS): "
echo ""
lua_chon_NAME
fi

if [[ $NAME = 'Tất cả website' ]];then
	if [ "$(ls -A /etc/wptt/vhost)" ]; then
		for entry in $(ls -A /etc/wptt/vhost); do
			domain=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
			path="/usr/local/lsws/$domain/html"
			i=1
			if [[ -d "$path" ]]; then
				if [[ ! -f "/etc/letsencrypt/live/$domain/cert.pem" && ! -f "/etc/letsencrypt/live/www.$domain/cert.pem" && ! -d "/usr/local/lsws/$domain/ssl" ]]; then
					continue
				fi
				_runing "Renew chuyển hướng SSL $domain"
				. /etc/wptt/ssl/wptt-renew-chuyen-huong $domain >/dev/null 2>&1
				_rundone "Renew chuyển hướng SSL $domain"
			fi
		done
	fi

	check_menu_wptangtoc_active=$1
	if [[ $check_menu_wptangtoc_active = "98" ]];then
		. /etc/wptt/wptt-ssl-main 1
	fi
	exit
fi


if [[ "$NAME" = "0" || "$NAME" = "" ]]; then
 . /etc/wptt/wptt-ssl-main 1
fi

pathcheck="/etc/wptt/vhost/.$NAME.conf"
if [[ ! -f "$pathcheck" ]]; then
    clear
echoDo "Tên miền không tồn tại trên hệ thống này"
    sleep 3
 . /etc/wptt/wptt-ssl-main 1
    exit
fi


if [[ ! -f "/etc/letsencrypt/live/$NAME/cert.pem" && ! -f "/etc/letsencrypt/live/www.$NAME/cert.pem" && ! -d "/usr/local/lsws/$NAME/ssl" ]]; then
echoDo "website $NAME bạn chưa được cài đặt chứng chỉ SSL"
return 2>/dev/null ; exit
fi


_runing "Cấu hình renew chuyển hướng"

if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
    giatuanwww=$(wp option get home --path=/usr/local/lsws/$NAME/html --allow-root | grep 'www.')
    if [[ $giatuanwww ]]; then
        wp option update home "https://www.$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1 2>/dev/null
        wp option update siteurl "https://www.$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1 2>/dev/null
    else
        wp option update home "https://$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1 2>/dev/null
        wp option update siteurl "https://$NAME" --path=/usr/local/lsws/$NAME/html --allow-root >/dev/null 2>&1 2>/dev/null
    fi
fi


checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdns" = "" ]]; then
    checkdns=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi

ip=$(curl -s myip.directadmin.com)
if [[ "$ip" = "" ]]; then
    ip=$(curl -s ifconfig.me)
fi

checkdnscname=$(host www.$NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
if [[ "$checkdnscname" = "" ]]; then
    checkdnscname=$(nslookup www.$NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
fi

path2="/usr/local/lsws/$NAME/html/.htaccess"


grepwww=$(grep -c 'RewriteCond %{HTTP_HOST} ^www' $path2)
grepwww2=$(grep -c 'RewriteCond %{HTTP_HOST} !^www' $path2)
grepssl=$(grep -c 'RewriteCond %{HTTPS}' $path2)

#xóa chuyển hướng http to https
sed -i '/RewriteCond %{HTTPS} !=on/,+1d' "$path2"

#xóa chuyển hướng www to non-www
sed -i '/RewriteCond %{HTTP_HOST} ^www/,+1d' "$path2"
#xóa chuyển hướng non-www to www
sed -i '/RewriteCond %{HTTP_HOST} ^'$NAME' /,+1d' "$path2"



#chuyển hướng http to https
sed -i '1 i RewriteCond %{HTTPS} !=on\
RewriteRule ^(.*)$ https:\/\/%{HTTP_HOST}%{REQUEST_URI} [L,R=301,NE]' /usr/local/lsws/"$NAME"/html/.htaccess


if [[ "$checkdns" = "$checkdnscname" ]]; then
	#chuyển hướng www to non www
    sed -i '1 i RewriteCond %{HTTP_HOST} ^www.'$NAME' [NC]\
RewriteRule ^(.*)$ https:\/\/'$NAME'/$1 [L,R=301,NC]' /usr/local/lsws/"$NAME"/html/.htaccess
fi

if [[ -f /usr/local/lsws/$NAME/html/wp-config.php ]]; then
    giatuanwww=$(wp option get home --path=/usr/local/lsws/$NAME/html --allow-root | grep 'www.')

    if [[ $giatuanwww ]]; then
        if [[ "$checkdns" = "$checkdnscname" ]]; then

			#xóa chuyển hướng www to non www
			sed -i '/RewriteCond %{HTTP_HOST} ^www/,+1d' "$path2"

			#chuyển hướng non-www to www
		    sed -i '1 i RewriteCond %{HTTP_HOST} ^'$NAME' [NC]\
RewriteRule ^(.*)$ https:\/\/www.'$NAME'/$1 [L,R=301,NC]' /usr/local/lsws/"$NAME"/html/.htaccess

        fi
    fi

fi

/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
_rundone "Cấu hình renew chuyển hướng"

check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-ssl-main 1
fi

