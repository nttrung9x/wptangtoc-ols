#!/bin/bash

NAME=$1
if [[ -d /etc/letsencrypt/live/$NAME || -d /usr/local/lsws/$NAME/ssl ]];then
rm -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron
systemctl restart crond.service
exit
fi

checkdns=$(host $NAME | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')
checkdns2=$(nslookup $NAME | grep Address | cut -f5 | grep -Eo -m 1 '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}')


ip=$(ip a | grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' | sed '/127.0.0.1/d' | sed '/192.168/d' | sort -u)
ip+=$(curl -s myip.directadmin.com)

#tro ve quay lai

if ! [[ $(echo $ip | grep $checkdns) || $(echo $ip | grep $checkdns2) ]]; then
return 2>/dev/null ; exit
fi

. /etc/wptt/ssl/wptt-caissl $NAME
# . /etc/wptt/ssl/wptt-caissl-cache-dns $NAME
rm -f /etc/cron.d/cai-ssl-auto-$NAME-tu-dong.cron
systemctl restart crond.service

