#!/bin/bash

echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Bảo mật => Kích hoạt chống search                                |"
echo "========================================================================="
echo ""
echo ""
echo ""

. /etc/wptt/echo-color
check=$(cat /etc/fail2ban/jail.local | grep '#begin-ddos-search-wordpress')
if [[ $check = '' ]];then
echo "Xác nhận muốn kích hoạt chống ddos 404"
prompt="Nhập lựa chọn của bạn [1-2]: "
dongy="n"
options=("Đồng ý" "Không đồng ý")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongy="y"
			break
			;;

		2)
			dongy="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nBạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
		*)
			printf "Bạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
	esac
done

if [[ $dongy = 'n' ]];then
. /etc/wptt/wptt-bao-mat-main 1
fi

_runing "Kích hoạt chặn chống ddos search"

if [ "$(ls -At /etc/wptt/vhost)" ]; then
	selects=()
	for entry in $(ls -A /etc/wptt/vhost); do
		NAME=$(echo $entry | sed 's/^.//' | sed 's/.conf//')
		if [ "$NAME" != "${NAME/./}" ]; then
			if [[ ! $(cat /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf| grep 'accesslog') ]]; then
				sed -i -e '/^errorlog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
				sed -i -e '/^accesslog /,/^}$/d' /usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
echo '
errorlog $VH_ROOT/logs/error.log {
  useServer               1
  logLevel                ERROR
  rollingSize             10M
}

accesslog $VH_ROOT/logs/access.log {
  useServer               0
  rollingSize             10M
  keepDays                30
  compressArchive         1
}' >>/usr/local/lsws/conf/vhosts/"$NAME"/"$NAME".conf
		mkdir -p /usr/local/lsws/"$NAME"/logs
		chown -R nobody:nobody /usr/local/lsws/"$NAME"/logs
		chmod 700 /usr/local/lsws/"$NAME"/logs
		/usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
			fi
		fi
	done
fi



echo '#begin-ddos-search-wordpress
[ddos-search-wptangtoc]
enabled = true
action = iptables-multiport[name=wordpress, port="http,https", protocol=tcp]
port = http,https
filter = ddos-search-wptangtoc
logpath = /usr/local/lsws/*/logs/access.log
maxretry = 5
bantime = 7200
findtime = 15
#end-ddos-search-wordpress' >>/etc/fail2ban/jail.local
sed -i "s/banaction = iptables-multiport/banaction = firewallcmd-ipset/g" /etc/fail2ban/jail.local

echo '[Definition]
failregex = ^<HOST> - .* "(GET|POST|HEAD).*\/?s=.*HTTP.*200.*$' >/etc/fail2ban/filter.d/ddos-search-wptangtoc.conf

fail2ban-client reload >/dev/null 2>&1
systemctl restart fail2ban
_rundone "Kích hoạt chặn chống ddos search"
echo "Nếu trong 15 giây mà yêu cầu 5 yêu cầu search thì IP sẽ bị khóa trong 2 tiếng"
fi


if [[ $check ]];then
echo "Bạn đang kích họat chống ddos 404"
echo "Xác nhận muốn hủy kích hoạt chống ddos 404"
prompt="Nhập lựa chọn của bạn [1-2]: "
dongy="n"
options=("Đồng ý" "Không đồng ý")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			dongy="y"
			break
			;;

		2)
			dongy="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nBạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
		*)
			printf "Bạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
	esac
done

if [[ $dongy = 'n' ]];then
. /etc/wptt/wptt-bao-mat-main 1
fi

_runing "Hủy kích hoạt chống ddos 404"
# sed -i '/chan search ddos wptangtoc/,+8d' /etc/fail2ban/jail.local
sed -i -e '/^#begin-ddos-search-wordpress/,/^#end-ddos-search-wordpress$/d' /etc/fail2ban/jail.local
fail2ban-client reload >/dev/null 2>&1
systemctl restart fail2ban
_rundone "Hủy kích hoạt chống ddos 404"
fi


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-bao-mat-main 1
fi

