#!/bin/bash
echo ""
echo ""
echo ""
echo "========================================================================="
echo "|Quản lý PHP => Thay đổi max_execution_time PHP                         |"
echo "========================================================================="
echo ""
echo ""
echo ""
. /etc/wptt/.wptt.conf
. /etc/wptt/php/wptt-php-version-domain 1

echo "Lựa chọn phiên bản PHP bạn muốn cấu hình max_execution_time php.ini:"
. /etc/wptt/php/tenmien-php

. /etc/wptt/echo-color
if [[ $LSPHP = "" || $LSPHP = "0" ]];then
    . /etc/wptt/wptt-php-ini-main 98
fi

echo "Mọi thứ đã được mình cầu hình tối ưu hết rồi"
echo "Nếu bạn có nhu cầu thực thi dài khi đã thực thi xong thì hãy vui lòng khôi phục vụ về để đảm bảo hiệu suất và bảo mật"
# echo "chung minh cung co ho tro tinh nang khoi phuc trong menu cua WPTangToc OLS"
echo "max_execution_time hiện tại $LSPHP giá trị là$(cat /usr/local/lsws/$LSPHP/etc/php.ini | grep 'max_execution_time' | cut -f2 -d '=') giây"
echo ""
echo ""
read -p "Nhập số thời gian max_execution_time bạn muốn thay đổi php.ini
Lưu ý: Nhập số nguyên dương [0=Thoát]: " port
if [[ "$port" = "0" || "$port" = "" ]]; then
    clear
    . /etc/wptt/wptt-php-ini-main 98
    exit
fi

# port=$(echo $port | sed 's/mb//g' | sed 's/MB//g'| sed 's/M//g'| sed 's/m//g' | sed 's/ //g' | sed 's/-//g')

if [[ ! $port =~ ^-?[0-9]+$ ]]; then
    clear
    echoDo "Nhập sai trường dữ liệu hãy nhập số tự nhiện"
    . /etc/wptt/wptt-php-ini-main 98
	exit
fi

echo "Xác nhận bạn muốn thay đổi max_execution_time thành ${port} giây"
prompt="Nhập lựa chọn của bạn [1-2]: "
check="n"
options=("Đồng ý" "Không đồng ý")
PS3="$prompt"
select opt in "${options[@]}"; do
	case "$REPLY" in
		1)
			check="y"
			break
			;;

		2)
			check="n"
			break
			;;

		$((${#options[@]} + 1)))
			printf "\nBạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
		*)
			printf "Bạn nhập sai hệ thống sẽ chọn là không đồng ý\n"
			break
			;;
	esac
done


if [[ "$check" = "y" ]]; then
	# php_server=$(php -i | grep php.ini | grep Loaded | cut -c 30-80 | cut -f5 -d "/")
. /etc/wptt/echo-color
_runing "Cấu hình max_execution_time $LSPHP giá trị là ${port} giây" 
	php=$(echo "/usr/local/lsws/$LSPHP/etc/php.ini")
	if [[ ! -f $php ]];then
_runloi "Cấu hình max_execution_time $LSPHP giá trị là ${port} giây" 
echo "Không xác định được file php.ini"
. /etc/wptt/wptt-php-ini-main 1
exit
	fi

    sed -i "/max_execution_time/d" "$php"
    sed -i "/max-execution-time/a max_execution_time = ${port}" "$php"

    /usr/local/lsws/bin/lswsctrl restart >/dev/null 2>&1
_rundone "Cấu hình max_execution_time $LSPHP giá trị là ${port} giây" 

    echo "-------------------------------------------------------------------------"
    echo "Khi bạn thực thi một công việc nào đó cần nhi thời gian thực thi xong"
	echo "thì hãy khôi phục lại thành 120 để nâng cao bảo mật và ổn định hệ thống"
    echo "-------------------------------------------------------------------------"
fi


check_menu_wptangtoc_active=$1
if [[ $check_menu_wptangtoc_active = "98" ]];then
. /etc/wptt/wptt-php-ini-main 1
fi

